;WITH CTE_DEDUP AS
(
	SELECT CAST(A.EMAIL  AS NVARCHAR(255)) AS email,
		   CAST(A.TELEFONE AS NVARCHAR(255)) AS telefone,
		   CAST(B.SEGMENTO AS NVARCHAR(255)) AS segmento_perfectdraft_recompra,
		   CAST(B.CLASS_TEMPO_REC AS NVARCHAR(255)) AS tempo_perfectdraft_recompra
		   ,ROW_NUMBER() OVER (PARTITION BY A.EMAIL ORDER BY A.DT_CADASTRO DESC) AS DEDUP
	  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS A (NOLOCK)
	 INNER JOIN [Ambev_016_PerfectDraft_BI].[dbo].[TB_GOLD_SEGMENTO_RECOMPRA] AS B (NOLOCK)
		ON A.CPF_CNPJ = B.CPF_CNPJ
	 WHERE A.QA_EMAIL = 'VALIDO'
	   AND A.EMAIL NOT LIKE '%VTEX%'
	   AND NULLIF(A.EMAIL,'') IS NOT NULL
)
SELECT *
  FROM CTE_DEDUP
 WHERE DEDUP = 1
