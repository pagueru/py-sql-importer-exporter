
--segmento_perfectdraft_tempo_recompra
;WITH CTE_RECOMPRA AS
(
	SELECT A.EMAIL,
		   A.TELEFONE,
		   B.SEGMENTO,
		   B.CLASS_TEMPO_REC,
		   ROW_NUMBER() OVER (PARTITION BY A.EMAIL ORDER BY A.DT_CADASTRO DESC) AS DEDUP
	  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS A (NOLOCK)
	 INNER JOIN Ambev_016_PerfectDraft_BI..TB_GOLD_SEGMENTO_RECOMPRA AS B (NOLOCK)
		ON A.CPF_CNPJ = B.CPF_CNPJ
	 WHERE A.QA_EMAIL = 'VALIDO'
	   AND A.EMAIL NOT LIKE '%VTEX%'
	   AND NULLIF(A.EMAIL,'') IS NOT NULL
)
SELECT CAST(EMAIL  AS NVARCHAR(255)) AS email,
	   CAST(TELEFONE AS NVARCHAR(255)) AS telefone,
	   CAST(SEGMENTO AS NVARCHAR(255)) AS segmento_perfectdraft_recompra,
	   CAST(CLASS_TEMPO_REC AS NVARCHAR(255)) AS tempo_perfectdraft_recompra
  FROM CTE_RECOMPRA
 WHERE DEDUP = 1

--segmento_perfectdraft
;WITH CTE_SEGMENTO AS
(
	SELECT A.EMAIL,
		   A.TELEFONE,
		   B.CLASSE_SEGMENTO,
		   ROW_NUMBER() OVER (PARTITION BY A.EMAIL ORDER BY A.DT_CADASTRO DESC) AS DEDUP
	  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS A (NOLOCK)
	 INNER JOIN Ambev_016_PerfectDraft_BI..TB_SEGMENTACAO_DINAMICA_PD AS B (NOLOCK)
		ON A.ID_CLIENTE = B.ID_CLIENTE
	 WHERE A.QA_EMAIL = 'VALIDO'
	   AND A.EMAIL NOT LIKE '%VTEX%'
	   AND NULLIF(A.EMAIL,'') IS NOT NULL
)
SELECT CAST(EMAIL AS NVARCHAR(255)) AS email,
       CAST(TELEFONE AS NVARCHAR(255)) AS telefone,
	   CAST(CLASSE_SEGMENTO AS NVARCHAR(255)) AS segmento_perfectdraft_v2
  FROM CTE_SEGMENTO
 WHERE DEDUP = 1

--segmento_perfectdraft_compradores
;WITH CTE_COMPRADORES AS
(
	SELECT CAST(A.EMAIL AS NVARCHAR(255)) AS email,
		   CONVERT(VARCHAR(50),A.DT_ULTIMO_PEDIDO,103) AS dt_ultimo_pedido,
		   CAST(CASE WHEN DATEDIFF(DAY,A.DT_ULTIMO_PEDIDO,GETDATE()) <= 30 THEN 'Compradores 30 dias' ELSE 'Clientes' END AS NVARCHAR(255)) AS SegmentoCompradores,
		   ROW_NUMBER() OVER (PARTITION BY A.EMAIL ORDER BY A.DT_CADASTRO DESC) AS DEDUP
	  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS A (NOLOCK)
	 WHERE A.QA_EMAIL = 'VALIDO'
	   AND A.EMAIL NOT LIKE '%VTEX%'
	   AND NULLIF(A.EMAIL,'') IS NOT NULL
)
SELECT CAST(EMAIL AS NVARCHAR(255)) AS email,
	   CONVERT(VARCHAR(50),DT_ULTIMO_PEDIDO,103) AS dt_ultimo_pedido,
	   CAST(SegmentoCompradores AS NVARCHAR(255)) AS SegmentoCompradores
  FROM CTE_COMPRADORES
 WHERE DEDUP = 1

--newsletter_perfectdraft
;WITH CTE_NEWSLETTER AS
(
	SELECT DISTINCT
		   A.EMAIL,
		   CAST('NEWSLETTER PERFECTDRAFT' AS NVARCHAR(255)) AS ORIGEM_CADASTRO,
		   A.OPTIN_NEWSLETTER,
		   ROW_NUMBER() OVER (PARTITION BY A.EMAIL ORDER BY A.DT_CRIACAO DESC) AS DEDUP
	  FROM Ambev_014_PerfectDraft..TB_LEADS_NEWSLETTER_PERFECT_DRAFT AS A (NOLOCK)
	 WHERE A.QA_EMAIL = 'VALIDO'
	   AND A.EMAIL NOT LIKE '%VTEX%'
	   AND NULLIF(A.EMAIL,'') IS NOT NULL
	   AND A.OPTIN_NEWSLETTER = 'True'
)
SELECT CAST(EMAIL AS NVARCHAR(255)) AS email,
	   CAST(ORIGEM_CADASTRO AS NVARCHAR(255)) AS origem_cadastro,
	   CAST(optin_newsletter AS NVARCHAR(255)) AS optin_newsletter
  FROM CTE_NEWSLETTER
 WHERE DEDUP = 1

--perfectdraft_udc_zedelivery
;WITH CTE_ZE_DELIVERY AS
(
	SELECT DISTINCT
		   A.EMAIL,
		   A.TELEFONE,
		   A.DT_CADASTRO,
		   B.BAIRRO,
		   ROW_NUMBER() OVER (PARTITION BY EMAIL ORDER BY DT_CADASTRO DESC) AS DEDUP
	  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS A (NOLOCK)
	 INNER JOIN Ambev_014_PerfectDraft..TB_BAIRROS_ZE_DELIVERY AS B (NOLOCK)
	    ON A.UF COLLATE Latin1_General_CI_AI = B.UF	COLLATE Latin1_General_CI_AI
	   AND A.CIDADE COLLATE Latin1_General_CI_AI = B.CIDADE COLLATE Latin1_General_CI_AI
	   AND A.BAIRRO COLLATE Latin1_General_CI_AI = B.BAIRRO COLLATE Latin1_General_CI_AI
	 INNER JOIN Ambev_014_PerfectDraft..VW_VTEX_PEDIDO_COMPLETO AS C (NOLOCK)
	    ON A.CPF_CNPJ = C.CPF_CNPJ
	 WHERE A.QA_EMAIL = 'VALIDO'
	   AND A.EMAIL NOT LIKE '%VTEX%'
	   AND NULLIF(A.EMAIL,'') IS NOT NULL
)
SELECT CAST(EMAIL AS NVARCHAR(255)) AS email,
	   CAST(TELEFONE AS NVARCHAR(255)) AS telefone,
       CAST(BAIRRO AS NVARCHAR(255)) AS bairro_ze_delivery
  FROM CTE_ZE_DELIVERY
 WHERE DEDUP = 1

--perfectdraft_leads_aniversario
;WITH CTE_NIVER AS
(
	SELECT DISTINCT
		   A.EMAIL,
		   AdAgency_ADDB.dbo.FC_HASH_MD5(A.EMAIL) AS HASH_CLIENTE,
		   CONVERT(VARCHAR(50), A.DT_NASCIMENTO,103) AS	DT_NASCIMENTO,
		   A.DT_CRIACAO,
		   A.OPTIN_NEWSLETTER,
		   ROW_NUMBER() OVER (PARTITION BY A.EMAIL ORDER BY A.DT_CRIACAO DESC) AS DEDUP
	  FROM Ambev_014_PerfectDraft..TB_LEADS_NEWSLETTER_PERFECT_DRAFT AS A (NOLOCK)
	 WHERE (OPTIN_NEWSLETTER = 'True' AND DT_NASCIMENTO IS NOT NULL)
	   AND A.QA_EMAIL = 'VALIDO'
	   AND A.EMAIL NOT LIKE '%VTEX%'
	   AND NULLIF(A.EMAIL,'') IS NOT NULL
	   AND NOT EXISTS (
						  SELECT *
						   FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS B (NOLOCK)
						  WHERE A.EMAIL = B.EMAIL
							AND B.ORIGEM IN ('API VTEX - LOJA PRINCIPAL','API VTEX - MAIN')
					   )
)
SELECT CAST(EMAIL AS NVARCHAR(255)) AS email,
       CAST(DT_NASCIMENTO AS NVARCHAR(255)) AS [data de nascimento],
       CAST(HASH_CLIENTE AS NVARCHAR(255)) AS hash_cliente,
       CAST(OPTIN_NEWSLETTER AS NVARCHAR(255)) AS optin_newsletter,
       CAST('True' AS NVARCHAR(255)) AS lead_perfectdraft
  FROM CTE_NIVER
 WHERE DEDUP = 1

--perfectdraft_tipo_lead
;WITH CTE_LEAD AS
(
	SELECT DISTINCT
		   ISNULL(A.PRIMEIRO_NOME,'OlÃ¡') AS primeiro_nome,
		   A.EMAIL,
		   CAST(AdAgency_ADDB.dbo.FC_HASH_MD5(A.EMAIL) AS VARCHAR(255)) AS hash_cliente,
		   IIF(DATEDIFF(DAY, DT_CADASTRO, GETDATE()) <= 90, 'lead_recente', 'lead_antigo') AS tipo_lead,
		   ROW_NUMBER() OVER (PARTITION BY A.EMAIL ORDER BY DT_CADASTRO DESC) AS DEDUP
	  FROM [Ambev_014_PerfectDraft]..TB_VTEX_CLIENTE AS A
	 INNER JOIN Ambev_016_PerfectDraft_BI..TB_GOLD_SEGMENTO AS B
		ON A.EMAIL = B.EMAIL
	 WHERE A.DT_ULTIMO_PEDIDO IS NULL
	   AND A.OPTIN = 1
	   AND B.SEGMENTO = 'Lead'
	   AND A.QA_EMAIL = 'VALIDO'
	   AND A.EMAIL NOT LIKE '%VTEX%'
	   AND NULLIF(A.EMAIL,'') IS NOT NULL
)
SELECT CAST(EMAIL AS NVARCHAR(255)) as email,
	   CAST(HASH_CLIENTE AS NVARCHAR(255)) as hash_cliente,
	   CAST(tipo_lead AS NVARCHAR(255)) as tipo_lead
  FROM CTE_LEAD
WHERE DEDUP = 1
