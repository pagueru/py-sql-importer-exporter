--segmento_perfectdraft_tempo_recompra
SELECT CAST(A.EMAIL  AS NVARCHAR(255)) AS email,
       CAST(A.TELEFONE AS NVARCHAR(255)) AS telefone,
       CAST(B.SEGMENTO AS NVARCHAR(255)) AS segmento_perfectdraft_recompra,
	   CAST(B.CLASS_TEMPO_REC AS NVARCHAR(255)) AS tempo_perfectdraft_recompra
  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS A (NOLOCK)
 INNER JOIN [Ambev_016_PerfectDraft_BI].[dbo].[TB_GOLD_SEGMENTO_RECOMPRA] AS B (NOLOCK)
	ON A.CPF_CNPJ = B.CPF_CNPJ
 WHERE A.QA_EMAIL = 'VALIDO'
   AND A.EMAIL NOT LIKE '%VTEX%'
   AND NULLIF(A.EMAIL,'') IS NOT NULL

--segmento_perfectdraft
SELECT CAST(A.EMAIL AS NVARCHAR(255)) AS EMAIL,
       CAST(A.TELEFONE AS NVARCHAR(255)) AS telefone,
	   CAST(B.CLASSE_SEGMENTO AS NVARCHAR(255)) AS segmento_perfectdraft_v2
  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS A (NOLOCK)
 INNER JOIN [Ambev_016_PerfectDraft_BI].[dbo].[TB_SEGMENTACAO_DINAMICA_PD] AS B (NOLOCK)
    ON A.ID_CLIENTE = B.ID_CLIENTE
 WHERE A.EMAIL NOT LIKE '%VTEX%'
   AND NULLIF(A.EMAIL,'') IS NOT NULL

--segmento_perfectdraft_compradores
SELECT CAST(EMAIL AS NVARCHAR(255)) AS email,
	   CONVERT(VARCHAR(50),DT_ULTIMO_PEDIDO,103) AS dt_ultimo_pedido,
       CAST(CASE WHEN DATEDIFF(DAY,DT_ULTIMO_PEDIDO,GETDATE()) <= 30 THEN 'Compradores 30 dias' ELSE 'Clientes' END AS NVARCHAR(255)) AS SegmentoCompradores
  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE (NOLOCK)
 WHERE EMAIL NOT LIKE '%VTEX%'
   AND NULLIF(EMAIL,'') IS NOT NULL

--newsletter_perfectdraft
SELECT EMAIL,
       CAST('NEWSLETTER PERFECTDRAFT' AS NVARCHAR(255)) AS ORIGEM_CADASTRO,
	   OPTIN_NEWSLETTER AS optin_newsletter
  FROM Ambev_014_PerfectDraft..TB_LEADS_NEWSLETTER_PERFECT_DRAFT (NOLOCK)
 WHERE OPTIN_NEWSLETTER = 'True'
   AND NULLIF(EMAIL,'') IS NOT NULL

--perfectdraft_udc_zedelivery
;WITH CTE_ZE_DELIVERY AS
(
	SELECT DISTINCT
		   A.EMAIL,
		   A.TELEFONE,
		   A.DT_CADASTRO,
		   B.BAIRRO AS BAIRRO_ZE_DELIVERY
	  FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS A (NOLOCK)
	 INNER JOIN Ambev_014_PerfectDraft..TB_BAIRROS_ZE_DELIVERY AS B (NOLOCK)
	    ON A.UF		  COLLATE Latin1_General_CI_AI = B.UF	COLLATE Latin1_General_CI_AI
	   AND A.CIDADE COLLATE Latin1_General_CI_AI = B.CIDADE COLLATE Latin1_General_CI_AI
	   AND A.BAIRRO COLLATE Latin1_General_CI_AI = B.BAIRRO COLLATE Latin1_General_CI_AI
	 INNER JOIN [Ambev_014_PerfectDraft].[dbo].[VW_VTEX_PEDIDO_COMPLETO] AS C (NOLOCK)
	    ON A.CPF_CNPJ = C.CPF_CNPJ
	 WHERE A.EMAIL NOT LIKE '%vtex%'
       AND NULLIF(A.EMAIL,'') IS NOT NULL
),
  CTE_DEDUP AS
(
	SELECT *, ROW_NUMBER() OVER (PARTITION BY EMAIL ORDER BY DT_CADASTRO DESC) AS DEDUP
	  FROM CTE_ZE_DELIVERY
)
SELECT CAST(EMAIL AS NVARCHAR(255)) AS email,
	   CAST(TELEFONE AS NVARCHAR(255)) AS telefone,
       CAST(BAIRRO_ZE_DELIVERY AS NVARCHAR(255)) AS bairro_ze_delivery
  FROM CTE_DEDUP
 WHERE DEDUP = 1

--perfectdraft_leads_aniversario
;WITH CTE_NIVER AS
(
	SELECT EMAIL
		   ,AdAgency_ADDB.dbo.FC_HASH_MD5(EMAIL)	AS  HASH_CLIENTE
		   ,CONVERT(VARCHAR(50), DT_NASCIMENTO,103)	AS	DT_NASCIMENTO
		   ,DT_CRIACAO
		   ,OPTIN_NEWSLETTER
	  FROM [Ambev_014_PerfectDraft].[dbo].[TB_LEADS_NEWSLETTER_PERFECT_DRAFT] AS A (NOLOCK)
	 WHERE (OPTIN_NEWSLETTER = 'True' AND DT_NASCIMENTO IS NOT NULL)
       AND NULLIF(A.EMAIL,'') IS NOT NULL
	   AND NOT EXISTS (
						  SELECT *
						   FROM Ambev_014_PerfectDraft..TB_VTEX_CLIENTE AS B (NOLOCK)
						  WHERE A.EMAIL = B.EMAIL
							AND B.ORIGEM IN ('API VTEX - LOJA PRINCIPAL','API VTEX - MAIN')
					   )
),
  CTE_DEDUP AS
(
	SELECT *
	  FROM (
				SELECT *, ROW_NUMBER() OVER (PARTITION BY EMAIL ORDER BY HASH_CLIENTE) AS IDD
				  FROM CTE_NIVER
		   ) X
	 WHERE X.IDD = 1
)
SELECT CAST(EMAIL AS NVARCHAR(255)) AS email,
       CAST(DT_NASCIMENTO AS NVARCHAR(255)) AS [data de nascimento],
       CAST(HASH_CLIENTE AS NVARCHAR(255)) AS hash_cliente,
       CAST(OPTIN_NEWSLETTER AS NVARCHAR(255)) AS optin_newsletter,
       CAST('True' AS NVARCHAR(255)) AS lead_perfectdraft
  FROM CTE_DEDUP

--perfectdraft_tipo_lead
;WITH CTE_LEAD AS
(
	SELECT *
	  FROM (
				SELECT ISNULL(A.PRIMEIRO_NOME,'OlÃ¡') AS primeiro_nome,
					   A.EMAIL,
					   CAST(AdAgency_ADDB.dbo.FC_HASH_MD5(A.EMAIL) AS VARCHAR(255)) AS hash_cliente,
					   ROW_NUMBER() OVER (PARTITION BY A.EMAIL ORDER BY DT_CADASTRO DESC) AS dedup,
					   IIF(DATEDIFF(DAY, DT_CADASTRO, GETDATE()) <= 90, 'lead_recente', 'lead_antigo') AS tipo_lead
				  FROM [Ambev_014_PerfectDraft]..TB_VTEX_CLIENTE AS A
				 INNER JOIN [Ambev_016_PerfectDraft_BI].[dbo].[TB_GOLD_SEGMENTO] AS B
					ON A.EMAIL = B.EMAIL
				 WHERE A.DT_ULTIMO_PEDIDO IS NULL
				   AND A.EMAIL NOT LIKE '%VTEX%'
				   AND A.OPTIN = 1
				   AND B.SEGMENTO = 'Lead'
                   AND NULLIF(A.EMAIL,'') IS NOT NULL
		   ) AS X
	 WHERE X.DEDUP = 1
)
SELECT CAST(EMAIL AS NVARCHAR(255)) as email,
	   CAST(HASH_CLIENTE AS NVARCHAR(255)) as hash_cliente,
	   CAST(tipo_lead AS NVARCHAR(255)) as tipo_lead
  FROM CTE_LEAD
